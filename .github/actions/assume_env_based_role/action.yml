name: assume env based role
description: Composite action to assume an environment-based AWS role.
runs:
  using: composite
  steps:
      - name: assume env based role
        id: assume_role
        shell: bash
        run: |
          GITHUB_ENVIRONMENT="${{ github.event.inputs.environment }}"
          echo "Selected environment: ${GITHUB_ENVIRONMENT}"

          if [ "$GITHUB_ENVIRONMENT" = "dev" ]; then
            ROLE_ARN="${{ secrets.TFDEV_ROLE_ARN }}"
          elif [ "$GITHUB_ENVIRONMENT" = "staging" ]; then
            ROLE_ARN="${{ secrets.TFSTAGING_ROLE_ARN }}"
          elif [ "$GITHUB_ENVIRONMENT" = "prod" ]; then
            ROLE_ARN="${{ secrets.TFPROD_ROLE_ARN }}"
          else
            echo "Error: Unknown environment: ${GITHUB_ENVIRONMENT}"
            exit 1
          fi

          echo "Assuming role for $GITHUB_ENVIRONMENT"
          
          CREDS=$(aws sts assume-role --role-arn $ROLE_ARN --role-session-name TerraformSession)
          export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r .Credentials.AccessKeyId)
          export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r .Credentials.SecretAccessKey)
          export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r .Credentials.SessionToken)
          
          echo "Role assumed successfully."